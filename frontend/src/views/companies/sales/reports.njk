{% extends "layouts/dashboard.njk" %}

{% block title %}Platform Dashboard{% endblock %}

{% block content %}
{% include "components/dashboard-sidebar.njk" %}
{% include "components/dashboard-header.njk" %}

<style>
    :root {
        --bg-main: #0B0F14;
        --bg-second: #0D1117;
        --bg-card: #151B23;
        --accent: #FD420A;
        --accent-hover: #E33A08;
        --text-main: #F0F6FC;
        --text-muted: #8B949E;
        --border: #30363D;
        --accent-glow: rgba(253, 66, 10, 0.25);
    }

    body {
        background-color: var(--bg-main);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        overflow-x: hidden;
    }

    .status-pill {
        padding: 2px 10px;
        border-radius: 99px;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    #modal-overlay {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    #modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .modal-content {
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .loader {
        border: 3px solid rgba(253, 66, 10, 0.1);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
</style>

<main class="flex-1 overflow-y-auto p-6 lg:p-10">
    <div class="w-full space-y-8">

        <div class="mb-8">
            <nav class="flex mb-3 text-xs font-bold tracking-widest text-gray-500 flex-col md:flex-row gap-5"
                aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3 uppercase">
                    <li class="inline-flex items-center">
                        <a href="/companies/{{ company_information.id }}"
                            class="hover:text-white transition-colors">Negocio</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <a href="/companies/{{ company_information.id }}/sales" id="breadcrumb-workspace"
                                class="hover:text-white ml-1 md:ml-2 transition-colors">Ventas</a>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <span class="ml-1 md:ml-2 text-orange-500">Comprobantes</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div class="space-y-2">
                <h1 class="text-4xl font-black italic tracking-tighter uppercase">
                    <span class="text-(--accent)">Comprobantes</span>
                </h1>
                <p class="text-(--text-muted) font-medium">Historial de operaciones y estados de pago.</p>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                <div
                    class="bg-(--bg-second) border border-(--border) flex items-center px-4 py-2.5 rounded-2xl w-full sm:w-80 focus-within:border-(--accent) transition-all">
                    <svg class="w-5 h-5 text-(--text-muted)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" placeholder="Buscar ticket..."
                        class="bg-transparent border-none outline-none text-sm ml-3 w-full text-(--text-main) placeholder-(--text-muted)">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">

            {% for sale in sales %}
            <div class="glass-card rounded-3xl p-6 relative overflow-hidden group">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span
                            class="status-pill bg-green-500/10 text-green-500 border border-green-500/20">Completado</span>
                        <h3 class="text-xl font-black mt-3"># {{ sale.invoice }}</h3>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] uppercase font-bold text-(--text-muted)">Total</p>
                        <p class="text-lg font-black text-(--text-main)">S/ {{ sale.amount }}</p>
                    </div>
                </div>
                <div class="space-y-4 mb-8">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-(--bg-main) border border-(--border) flex items-center justify-center">
                            <svg class="w-4 h-4 text-(--text-muted)" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        {# <p class="text-sm font-semibold">Cliente: Inka S.A.C.</p> #}
                    </div>
                </div>
                <button
                    onclick="open_ticket('/companies/{{ company_information.id }}/sales/check/{{ sale.id }}', '{{ sale.invoice }}')"
                    class="w-full bg-(--bg-accent) hover:bg-(--accent) text-xs font-bold py-4 rounded-xl transition-all border border-(--border) hover:border-transparent uppercase tracking-widest cursor-pointer">
                    Ver Detalle
                </button>
            </div>
            {% endfor %}

        </div>

        <div class="flex items-center justify-between pt-10 border-t border-(--border)">
            <p class="text-(--text-muted) text-sm font-medium">PÃ¡gina {{ page }} de {{ pagination.q_pages }}</p>
            <div class="flex gap-4">
                {% if pagination.back %}
                <a href="{{ update_query(query, { page: page - 1 }) }}"
                    class="p-3 rounded-xl bg-(--bg-card) border border-(--border) hover:border-(--accent) transition-all cursor-pointer">
                    <i class="fa-solid fa-angle-left"></i>
                </a>
                {% else %}
                <span class="p-3 rounded-xl bg-(--bg-card) border border-(--border)">
                    <i class="fa-solid fa-angle-left"></i>
                </span>
                {% endif %}

                {% if pagination.next %}
                <a href="{{ update_query(query, { page: page + 1 }) }}"
                    class="p-3 rounded-xl bg-(--bg-card) border border-(--border) hover:border-(--accent) transition-all cursor-pointer">
                    <i class="fa-solid fa-angle-right"></i>
                </a>
                {% else %}
                <span class="p-3 rounded-xl bg-(--bg-card) border border-(--border)">
                    <i class="fa-solid fa-angle-right"></i>
                </span>
                {% endif %}
            </div>
        </div>

        <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div
                class="modal-content w-full max-w-5xl h-[85vh] bg-(--bg-card) border border-(--border) rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden">

                <div class="flex items-center justify-between px-8 py-6 border-b border-(--border)">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-(--accent) rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div>
                            <h2 id="modal-title" class="text-xl font-black uppercase tracking-tight">Detalle del Ticket
                            </h2>
                            <p id="modal-subtitle"
                                class="text-xs text-(--text-muted) font-bold tracking-widest uppercase">Vista
                                Previa de Documento</p>
                        </div>
                    </div>
                    <button onclick="close_modal()" class="p-2 hover:bg-(--bg-main) rounded-full transition-colors cursor-pointer">
                        <i class="fa-solid fa-close"></i>
                    </button>
                </div>

                <div class="flex-1 relative bg-white">
                    <div id="modal-loader"
                        class="absolute inset-0 flex flex-col items-center justify-center bg-(--bg-card) z-10">
                        <div class="loader mb-4"></div>
                        <p class="text-xs font-bold uppercase text-(--text-muted) tracking-widest">Cargando
                            documento...</p>
                    </div>
                    <iframe id="ticket-iframe" src=""
                        class="w-full h-full border-none opacity-0 transition-opacity duration-500"
                        onload="on_iframe_load()"></iframe>
                </div>

                <div class="px-8 py-4 bg-(--bg-main) border-t border-(--border) flex justify-end gap-3">
                    <button onclick="close_modal()"
                        class="px-6 py-2.5 rounded-xl border border-(--border) text-xs font-bold uppercase tracking-widest hover:bg-(--bg-card) transition-all cursor-pointer">Cerrar</button>
                    <button onclick="print_iframe()"
                        class="px-6 py-2.5 rounded-xl bg-(--accent) text-white text-xs font-bold uppercase tracking-widest hover:bg-(--accent-hover) transition-all cursor-pointer">Imprimir</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    function on_iframe_load() {
        const iframe = document.getElementById('ticket-iframe');
        const loader = document.getElementById('modal-loader');
        if (iframe && iframe.src && iframe.src !== window.location.href) {
            if (loader) loader.style.display = 'none';
            iframe.classList.replace('opacity-0', 'opacity-100');
        }
    }

    function open_ticket(url, id) {
        const overlay = document.getElementById('modal-overlay');
        const iframe = document.getElementById('ticket-iframe');
        const loader = document.getElementById('modal-loader');
        const title_el = document.getElementById('modal-title');

        if (title_el) title_el.innerText = `Detalle del Ticket ${id}`;
        if (iframe) {
            iframe.classList.remove('opacity-100');
            iframe.classList.add('opacity-0');
            iframe.src = url;
        }
        if (loader) loader.style.display = 'flex';
        if (overlay) overlay.classList.add('active');

        document.body.style.overflow = 'hidden';
    }

    function close_modal() {
        const overlay = document.getElementById('modal-overlay');
        const iframe = document.getElementById('ticket-iframe');

        if (overlay) overlay.classList.remove('active');
        document.body.style.overflow = 'auto';

        setTimeout(() => {
            if (iframe) iframe.src = "";
        }, 300);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('modal-overlay');

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') close_modal();
        });

        if (overlay) {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) close_modal();
            });
        }
    });

    function print_iframe() {
        const iframe = document.getElementById('ticket-iframe');
        if (!iframe) return;

        const iframeWindow = iframe.contentWindow || iframe.contentDocument?.defaultView;

        if (!iframeWindow) {
            alert("No se pudo acceder al contenido del documento.");
            return;
        }

        iframeWindow.focus();
        iframeWindow.print();
    }

</script>

{% include "components/dashboard-footer.njk" %}

{% endblock %}