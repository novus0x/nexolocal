{% extends "layouts/dashboard.njk" %}

{% block title %}Platform Dashboard{% endblock %}

{% block content %}
{% include "components/dashboard-sidebar.njk" %}
{% include "components/dashboard-header.njk" %}

<main class="flex-1 overflow-y-auto p-6 lg:p-10">
    <div class="w-full space-y-8">

        <div class="mb-8">
            <nav class="flex mb-3 text-xs font-bold tracking-widest text-gray-500 flex-col md:flex-row gap-5"
                aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3 uppercase">
                    <li class="inline-flex items-center">
                        <a href="/companies/{{ company_information.id }}"
                            class="hover:text-white transition-colors">Negocio</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <a href="/companies/{{ company_information.id }}/products" id="breadcrumb-workspace"
                                class="hover:text-white ml-1 md:ml-2 transition-colors">Productos</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <a href="/companies/{{ company_information.id }}/products/create" id="breadcrumb-workspace"
                                class="hover:text-white ml-1 md:ml-2 transition-colors">Nuevo</a>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <span class="ml-1 md:ml-2 text-orange-500">Importar</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="section-card border border-white/5 p-5 rounded-2xl flex items-start gap-4">
                <div
                    class="w-10 h-10 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-500 shrink-0">
                    <span class="font-bold text-lg">1</span>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-white mb-1">Prepara tu CSV</h4>
                    <p class="text-xs text-gray-500 leading-relaxed">Usa codificación UTF-8 para evitar errores con
                        tildes.</p>
                </div>
            </div>
            <div class="section-card border border-white/5 p-5 rounded-2xl flex items-start gap-4">
                <div
                    class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-500 shrink-0">
                    <span class="font-bold text-lg">2</span>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-white mb-1">Carga el Archivo</h4>
                    <p class="text-xs text-gray-500 leading-relaxed">Arrastra el archivo o búscalo en tu ordenador.</p>
                </div>
            </div>
            <div class="section-card border border-white/5 p-5 rounded-2xl flex items-start gap-4">
                <div
                    class="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center text-green-500 shrink-0">
                    <span class="font-bold text-lg">3</span>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-white mb-1">Verifica y Sube</h4>
                    <p class="text-xs text-gray-500 leading-relaxed">Revisa la tabla de previsualización y confirma.</p>
                </div>
            </div>
        </div>

        <form action="/companies/{{ company_information.id }}/products/import" method="POST" enctype="multipart/form-data">

            <div id="dropZone" class="drop-zone section-card rounded-4xl p-20 text-center cursor-pointer group mb-8">
                <input type="file" id="file_input" class="hidden" name="file" accept=".csv">
                <div
                    class="w-20 h-20 bg-white/5 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-white/5 group-hover:border-orange-500/50 transition-all">
                    <i class="fas fa-file-csv text-3xl text-gray-500 group-hover:text-[#FD420A]"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Selecciona tu archivo .csv</h3>
                <p class="text-gray-500 max-w-sm mx-auto mb-6 text-sm">Asegúrate de que las columnas coincidan con el
                    formato requerido (SKU, Nombre, Precio, Costo, Stock).</p>
                <button type="button"
                    class="px-6 py-2.5 bg-white/5 hover:bg-white/10 rounded-xl text-sm font-bold transition-all border border-white/10 cursor-pointer">
                    Examinar archivos</button>
            </div>

            <div id="preview_container" class="hidden">

                <div
                    class="sticky-actions py-4 mb-6 border-b border-white/5 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center text-green-500">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h3 id="fileNameDisplay" class="font-bold text-white leading-tight text-sm">archivo.csv</h3>
                            <p id="rowCountText" class="text-xs text-gray-500">0 filas cargadas correctamente</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <button onclick="reset_import()" type="button"
                            class="px-5 py-2.5 rounded-xl text-xs font-bold text-gray-400 hover:bg-white/5 hover:text-red-400 transition-all border border-transparent hover:border-red-500/20 cursor-pointer">
                            <i class="fas fa-trash-alt mr-2"></i> LIMPIAR
                        </button>
                        <button id="btnProcess" onclick="confirm_import()"
                            class="px-8 py-2.5 bg-[#FD420A] rounded-xl text-xs font-black text-white shadow-lg shadow-orange-900/20 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center gap-2 cursor-pointer">
                            <i class="fas fa-rocket"></i> PROCESAR E IMPORTAR
                        </button>
                    </div>
                </div>

                <div
                    class="section-card border border-white/5 rounded-2xl overflow-hidden shadow-2xl overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead class="bg-white/2 sticky top-0">
                            <tr id="tableHeader"
                                class="text-[10px] font-black uppercase tracking-widest text-gray-500 border-b border-white/5">
                            </tr>
                        </thead>
                        <tbody id="preview_table" class="text-gray-300 divide-y divide-white/3">
                        </tbody>
                    </table>
                </div>

            </div>
        </form>
    </div>
</main>

<script>
    const dropZone = document.getElementById('dropZone');
    const file_input = document.getElementById('file_input');
    const preview_container = document.getElementById('preview_container');
    const preview_table = document.getElementById('preview_table');
    const tableHeader = document.getElementById('tableHeader');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const rowCountText = document.getElementById('rowCountText');

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
        dropZone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });

    ['dragenter', 'dragover'].forEach(eName => {
        dropZone.addEventListener(eName, () => dropZone.classList.add('active'), false);
    });

    ['dragleave', 'drop'].forEach(eName => {
        dropZone.addEventListener(eName, () => dropZone.classList.remove('active'), false);
    });

    dropZone.addEventListener('drop', e => {
        const file = e.dataTransfer.files[0];
        if (file) handle_file(file);
    });

    dropZone.addEventListener('click', () => file_input.click());
    file_input.addEventListener('change', e => { if (e.target.files.length) handle_file(e.target.files[0]); });

    function handle_file(file) {
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert("Extensión no permitida. Solo archivos .csv");
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const text = e.target.result;
            parse_csv(text, file.name);
        };
        reader.readAsText(file);
    }

    function parse_csv(text, fileName) {
        // Limpiar líneas vacías y separar por líneas
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        if (lines.length < 2) {
            alert("El archivo parece estar vacío o le faltan los encabezados.");
            return;
        }

        // Detectar separador (coma o punto y coma)
        const firstLine = lines[0];
        const separator = firstLine.includes(';') ? ';' : ',';

        const headers = firstLine.split(separator).map(h => h.trim());
        const rows = lines.slice(1).map(line => line.split(separator).map(cell => cell.trim()));

        render_table(headers, rows);

        fileNameDisplay.innerText = fileName;
        rowCountText.innerText = `${rows.length} filas detectadas en el archivo`;

        dropZone.classList.add('hidden');
        preview_container.classList.remove('hidden');
    }

    function render_table(headers, rows) {
        // Render Headers
        tableHeader.innerHTML = headers.map(h => `<th class="px-6 py-4">${h}</th>`).join('');

        // Render Rows (máximo 50 para previsualización rápida si son miles)
        const visibleRows = rows.slice(0, 50);
        preview_table.innerHTML = visibleRows.map(row => `
                <tr class="hover:bg-white/[0.02] transition-colors">
                    ${row.map(cell => `<td class="px-6 py-4 truncate max-w-[200px]">${cell}</td>`).join('')}
                </tr>
            `).join('');

        if (rows.length > 50) {
            const extraCount = rows.length - 50;
            preview_table.innerHTML += `
                    <tr>
                        <td colspan="${headers.length}" class="px-6 py-8 text-center bg-white/[0.01]">
                            <span class="text-xs text-gray-500 font-bold tracking-widest uppercase">
                                ... y ${extraCount.toLocaleString()} filas más no mostradas en la previsualización ...
                            </span>
                        </td>
                    </tr>
                `;
        }
    }

    function reset_import() {
        preview_container.classList.add('hidden');
        dropZone.classList.remove('hidden');
        file_input.value = '';
        preview_table.innerHTML = '';
    }

    function confirm_import() {
        const modal = document.getElementById('statusModal');
        const fill = document.getElementById('progressFill');
        const title = document.getElementById('modalTitle');
        const msg = document.getElementById('modalMsg');
        const icon = document.getElementById('modalIcon');
        const closeBtn = document.getElementById('modalClose');

        modal.classList.remove('hidden');

        // Simulación de proceso de subida
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);

                // Vista de éxito
                icon.innerHTML = '<i class="fas fa-check-double text-3xl"></i>';
                icon.className = "w-20 h-20 mx-auto mb-6 flex items-center justify-center rounded-2xl bg-green-500/10 text-green-500";
                title.innerText = "¡Importación Exitosa!";
                msg.innerText = "Los productos han sido procesados y añadidos a tu base de datos correctamente.";
                closeBtn.classList.remove('hidden');
            }
            fill.style.width = progress + '%';
        }, 300);
    }

</script>

{% include "components/dashboard-footer.njk" %}

{% endblock %}