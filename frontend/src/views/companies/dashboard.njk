{% extends "layouts/dashboard.njk" %}

{% block title %}Platform Dashboard{% endblock %}

{% block content %}
{% include "components/dashboard-sidebar.njk" %}
{% include "components/dashboard-header.njk" %}

<style>
    :root {
        --bg-main: #0B0F14;
        --bg-second: #0D1117;
        --bg-card: #151B23;
        --accent: #FD420A;
        --accent-hover: #E33A08;
        --text-main: #F0F6FC;
        --text-muted: #8B949E;
        --border: #30363D;
        --accent-glow: rgba(253, 66, 10, 0.25);
    }

    .status-pill {
        padding: 2px 10px;
        border-radius: 99px;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .modal-overlay {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .modal-content {
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .loader {
        border: 3px solid rgba(253, 66, 10, 0.1);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
</style>

<main class="flex-1 overflow-y-auto p-6 lg:p-10">
    <div class="w-full space-y-8">

        <div class="flex flex-col lg:flex-row gap-4 mb-8">
            <div class="grow">
                <h2 class="text-2xl font-black italic uppercase">
                    <span class="text-(--accent)">{{ company_information.name }}</span>
                </h2>
            </div>
            {% if products.low_products_quantity > 0 %}
            <div class="flex gap-2">
                <div class="bg-red-500/10 border border-red-500/20 px-4 py-2 rounded-xl flex items-center gap-3">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xs"></i>
                    <span class="text-[11px] font-bold text-red-500">{{ products.low_products_quantity }}
                        {% if products.low_products_quantity > 1 %}
                        PRODUCTOS
                        {% else %}
                        PRODUCTO
                        {% endif %}
                        CON STOCK BAJO</span>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6" style="animation-delay: 0.3s">
                <div class="flex justify-between items-center mb-4">
                    <span class="p-2 bg-[#FD420A]/10 rounded-lg"><i
                            class="fas fa-cash-register text-[#FD420A]"></i></span>
                    <span class="text-[10px] font-bold text-green-500 bg-green-500/10 px-2 py-0.5 rounded">HOY</span>
                </div>
                <p class="text-gray-400 text-xs font-bold uppercase">Ventas del Día</p>
                <h3 class="text-3xl font-black mt-2">S/ {{ company.metrics.sales }}</h3>
                <p
                    class="text-[10px] mt-2 flex items-center gap-1 {% if company.metrics.sales_percent > 0 %} text-green-500 {% elif company.metrics.sales_percent < 0 %} text-red-400 {% else %} text-gray-500 {% endif %}">
                    {% if company.metrics.sales_percent > 0 %}
                    <i class="fas fa-arrow-up"></i>
                    {% elif company.metrics.sales_percent < 0 %} <i class="fas fa-arrow-down"></i>
                        {% else %}
                        <i class="fas fa-minus"></i>
                        {% endif %}
                        <span class="text-gray-500">{% if company.metrics.sales_percent > 0 %}+{% endif %}{{
                            company.metrics.sales_percent }}% respecto a ayer</span>
                </p>
            </div>

            <div class="glass-card p-6" style="animation-delay: 0.3s">
                <div class="flex justify-between items-center mb-4">
                    <span class="p-2 bg-[#1eb607]/10 rounded-lg">
                        <i class="fa-solid fa-coins text-[#1eb607]"></i>
                    </span>
                    <span class="text-[10px] font-bold text-green-500 bg-green-500/10 px-2 py-0.5 rounded">HOY</span>
                </div>
                <p class="text-gray-400 text-xs font-bold uppercase">Ganancia Neta</p>
                <h3 class="text-3xl font-black mt-2">S/ {{ company.metrics.net }}</h3>
                <p
                    class="text-[10px] mt-2 flex items-center gap-1 {% if company.metrics.net_percent > 0 %} text-green-500 {% elif company.metrics.net_percent < 0 %} text-red-400 {% else %} text-gray-500 {% endif %}">
                    {% if company.metrics.net_percent > 0 %}
                    <i class="fas fa-arrow-up"></i>
                    {% elif company.metrics.net_percent < 0 %} <i class="fas fa-arrow-down"></i>
                        {% else %}
                        <i class="fas fa-minus"></i>
                        {% endif %}
                        <span class="text-gray-500">{% if company.metrics.net_percent > 0 %}+{% endif %}{{
                            company.metrics.net_percent }}% respecto a ayer</span>
                </p>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="p-2 bg-blue-500/10 rounded-lg"><i class="fas fa-users text-blue-500"></i></span>
                    <span class="text-[10px] font-bold text-gray-500 bg-white/5 px-2 py-0.5 rounded">PROMEDIO</span>
                </div>
                <p class="text-gray-400 text-xs font-bold uppercase">Tickets Generados</p>
                <h3 class="text-3xl font-black mt-2">{{ company.metrics.tickets }}</h3>
                <p class="text-[10px] text-gray-500 mt-2"><i class="fas fa-shopping-bag mr-1"></i> Ticket promedio:
                    S/ {{ company.metrics.tickets_average }}</p>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="p-2 bg-purple-500/10 rounded-lg"><i class="fas fa-wallet text-purple-500"></i></span>
                    <span class="text-[10px] font-bold text-red-500 bg-red-500/10 px-2 py-0.5 rounded">Mes</span>
                </div>
                <p class="text-gray-400 text-xs font-bold uppercase">Gastos del Mes</p>
                <h3 class="text-3xl font-black mt-2">S/ {{ company.metrics.expenses }}</h3>
                <p class="text-[10px] text-gray-500 mt-2"><i class="fas fa-clock mr-1"></i> Próximo pago: En X días
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            {% if company.cash.open %}
            <div class="glass-card p-6 lg:col-span-2">
                <div class="flex items-start justify-between gap-4 mb-6">
                    <div>
                        <h4 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-cash-register text-[#FD420A]"></i>
                            Cierre de Caja Diario
                        </h4>
                        <p class="text-xs text-gray-500 mt-1">
                            Estado de flujo de efectivo en tiempo real
                        </p>
                    </div>

                    <span class="text-[10px] font-bold tracking-widest px-3 py-1 rounded-full 
                   bg-green-500/10 text-green-400 border border-green-500/20 uppercase">
                        Abierto
                    </span>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-[#0B0F14] border border-[#30363D] p-4 rounded-xl">
                        <p class="text-[10px] text-gray-500 font-bold uppercase">Apertura</p>
                        <p class="text-lg  font-bold mt-1">S/ {{ company.cash.start }}</p>
                    </div>
                    <div class="bg-[#0B0F14] border border-[#30363D] p-4 rounded-xl text-green-500">
                        <p class="text-[10px] text-gray-500 font-bold uppercase">Ingresos</p>
                        <p class="text-lg  font-bold mt-1">+ S/ {{ company.cash.in }}</p>
                    </div>
                    <div class="bg-[#0B0F14] border border-[#30363D] p-4 rounded-xl text-red-400">
                        <p class="text-[10px] text-gray-500 font-bold uppercase">Egresos</p>
                        <p class="text-lg  font-bold mt-1">- S/ {{ company.cash.out }}</p>
                    </div>
                    <div class="bg-[#FD420A]/5 border border-[#FD420A]/20 p-4 rounded-xl border-l-4 border-l-[#FD420A]">
                        <p class="text-[10px] text-[#FD420A] font-bold uppercase">Saldo Actual</p>
                        <p class="text-xl  font-bold mt-1">S/ {{ company.cash.current }}</p>
                    </div>
                </div>

                <div class="mt-8">
                    <h5 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Desglose por Medios de
                        Pago (Ingresos)</h5>

                    <div class="space-y-3">
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-green-500/10 flex items-center justify-center"><i
                                        class="fas fa-money-bill text-green-500 text-xs"></i></div>
                                <span class="font-medium">Efectivo</span>
                            </div>
                            <span class="text-green-400">S/ {{ company.cash.payment_method.cash }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-blue-500/10 flex items-center justify-center"><i
                                        class="fas fa-credit-card text-blue-500 text-xs"></i></div>
                                <span class="font-medium">Tarjetas (Visa/MC)</span>
                            </div>
                            <span class="text-green-400">S/ {{ company.cash.payment_method.card }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-purple-500/10 flex items-center justify-center"><i
                                        class="fas fa-mobile-alt text-purple-500 text-xs"></i></div>
                                <span class="font-medium">Digital (Yape/Plin)</span>
                            </div>
                            <span class="text-green-400">S/ {{ company.cash.payment_method.digital }}</span>
                        </div>
                    </div>
                    <h5 class="text-xs font-bold text-gray-400 uppercase mt-6 mb-4 tracking-wider">Desglose por Medios
                        de Pago (Salidas)</h5>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-green-500/10 flex items-center justify-center"><i
                                        class="fas fa-money-bill text-green-500 text-xs"></i></div>
                                <span class="font-medium">Efectivo</span>
                            </div>
                            <span class="text-red-400">S/ {{ company.cash.payment_metrics.cash }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-blue-500/10 flex items-center justify-center"><i
                                        class="fas fa-credit-card text-blue-500 text-xs"></i></div>
                                <span class="font-medium">Tarjetas (Visa/MC)</span>
                            </div>
                            <span class="text-red-400">S/ {{ company.cash.payment_metrics.card }}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-purple-500/10 flex items-center justify-center"><i
                                        class="fas fa-mobile-alt text-purple-500 text-xs"></i></div>
                                <span class="font-medium">Digital (Yape/Plin)</span>
                            </div>
                            <span class="text-red-400">S/ {{ company.cash.payment_metrics.digital }}</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-end">
                    <button onclick="open_modal('close_cash', 'modal-close-cash');"
                        class="text-[11px] font-bold bg-white text-black hover:bg-gray-200 px-4 py-2 rounded-lg transition-colors cursor-pointer">
                        Cerrar Caja
                    </button>
                </div>
            </div>
            {% else %}
            <div class="glass-card p-7 lg:col-span-2 rounded-2xl relative">

                <div class="flex items-start justify-between gap-4 mb-6">
                    <div>
                        <h4 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-cash-register text-[#FD420A]"></i>
                            Apertura de Caja
                        </h4>
                        <p class="text-xs text-gray-500 mt-1">
                            No hay una sesión activa. Debes abrir caja para registrar movimientos.
                        </p>
                    </div>

                    <span class="text-[10px] font-bold tracking-widest px-3 py-1 rounded-full 
                   bg-red-500/10 text-red-400 border border-red-500/20">
                        CERRADA
                    </span>
                </div>

                <form class="mt-4" action="/companies/{{ company_information.id }}/cash/open" method="post">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">

                        <div class="md:col-span-2">
                            <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">
                                Monto inicial
                            </label>

                            <div class="relative mt-2">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">S/</span>

                                <input type="number" name="initial_cash" step="0.01" min="0" required placeholder="0.00"
                                    class="w-full bg-[#0B0F14] border border-[#30363D] rounded-xl 
                               py-3 pl-11 pr-4 text-white text-lg 
                               focus:outline-none focus:border-[#FD420A] 
                               focus:ring-1 focus:ring-[#FD420A]/30 transition">
                            </div>

                            <p class="text-[11px] text-gray-500 mt-2">
                                Efectivo real con el que inicia la caja.
                            </p>
                        </div>

                        <button type="submit"
                            class="py-4 rounded-xl font-bold text-white bg-[#FD420A] hover:bg-[#E33A08] transition-all flex items-center justify-center gap-2 shadow-lg shadow-[#FD420A]/25 active:scale-[0.98] capitalize cursor-pointer">
                            <i class="fas fa-lock-open"></i>
                            Abrir Caja
                        </button>

                    </div>
                </form>
            </div>
            {% endif %}

            <div class="glass-card p-6 flex flex-col">
                <h4 class="text-lg font-bold mb-1">Acumulado Mes</h4>
                <p class="text-xs text-gray-500 mb-6">Resumen de cierres de Enero</p>

                <div class="grow space-y-4 overflow-y-auto pr-2 custom-scrollbar max-h-87.5">
                    {% for cash_session in company.metrics.month_cash_sessions.cash_month_list %}
                    <div class="p-3 bg-[#0B0F14] rounded-xl border border-[#30363D]">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-gray-500 uppercase">{{ cash_session.date }}</span>
                            {% if cash_session.has_difference %}
                            <span class="status-pill bg-red-500/10 text-red-500">Con Desfase</span>
                            {% else %}
                            <span class="status-pill bg-green-500/10 text-green-500">Cerrado</span>
                            {% endif %}
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-xs text-gray-400">Balance final</p>
                                {% if cash_session.has_difference %}
                                <p class="text-sm font-bold text-red-400">S/ {{ cash_session.difference }}</p>
                                {% else %}
                                <p class="text-sm font-bold text-green-400">S/ {{ cash_session.final_amount }}</p>
                                {% endif %}
                            </div>
                            {% if cash_session.has_difference %}
                            <i class="fas fa-exclamation-circle text-red-500 text-[10px]"></i>
                            {% else %}
                            <i class="fas fa-chevron-right text-gray-600 text-[10px]"></i>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-6 pt-6 border-t border-[#30363D]">
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-gray-400">Total Efectivo Acum.</span>
                        <span class="font-bold text-white">S/ {{ company.metrics.month_cash_sessions.total_cash_month }}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">Frecuencia de Cierre</span>
                        <span class="font-bold text-green-500">{{ company.metrics.month_cash_sessions.frequency }}% (Diario)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-card p-6 lg:col-span-2" style="animation-delay: 0.6s">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h4 class="font-bold">Desempeño Semanal</h4>
                        <p class="text-xs text-gray-500">Ventas brutas vs Gastos</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase">
                            <span class="w-2 h-2 rounded-full bg-[#FD420A]"></span> Ventas
                        </div>
                        <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase">
                            <span class="w-2 h-2 rounded-full bg-gray-600"></span> Gastos
                        </div>
                    </div>
                </div>
                <div class="h-75">
                    <canvas id="weekly_performance_chart"></canvas>
                </div>
            </div>

            <div class="glass-card p-6 flex flex-col">
                <h4 class="font-bold mb-6">Top Productos/Servicios - Hoy</h4>
                <div class="space-y-6">
                    {% for top_product_today in company.metrics.products.top_today %}
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 bg-[#1C2128] rounded-lg border border-[#30363D] flex items-center justify-center text-xs font-bold">
                            #{{ top_product_today.rank }}</div>
                        <div class="grow">
                            <p class="text-sm font-bold">{{ top_product_today.name }}</p>
                            <div class="w-full bg-[#30363D] h-1.5 rounded-full mt-2">
                                <div class="bg-[#FD420A] h-full rounded-full"
                                    style="width: {{ top_product_today.percent }}%"></div>
                            </div>
                        </div>
                        <span class="text-xs  text-gray-500">{{ top_product_today.total_qty }}</span>
                    </div>
                    {% endfor %}
                </div>
                <a href="/companies/{{ company_information.id }}/products"
                    class="text-center w-full mt-10 py-3 rounded-xl text-xs font-bold bg-[#FD420A] hover:bg-[#cd3101]  transition-colors cursor-pointer">
                    Ver Inventario Completo
                </a>
            </div>
        </div>

        <div id="modal-close-cash" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
            <div
                class="modal-content w-full max-w-5xl h-[85vh] bg-(--bg-card) border border-(--border) rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden">

                <div class="flex items-center justify-between px-8 py-6 border-b border-(--border)">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-(--accent) rounded-xl flex items-center justify-center">
                            <i class="fa-regular fa-cash-register"></i>
                        </div>
                        <div>
                            <h2 id="modal-title" class="text-xl font-black uppercase tracking-tight">Cerrar Caja</h2>
                        </div>
                    </div>
                    <button onclick="close_modal()"
                        class="p-2 hover:bg-(--bg-main) rounded-full transition-colors cursor-pointer">
                        <i class="fa-solid fa-close"></i>
                    </button>
                </div>

                <div class="flex-1 relative">
                    <div class="space-y-6 px-4 py-5">
                        <div class="space-y-2">
                            <label for="amount" class="block text-xs font-bold text-zinc-500 uppercase tracking-widest">
                                Efectivo Total Contado
                            </label>
                            <div class="relative group">
                                <span
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 font-semibold text-xl group-focus-within:text-orange-500 transition-colors">S/</span>
                                <input type="number" id="amount" step="0.01" placeholder="0.00"
                                    class="w-full bg-zinc-950 border border-zinc-800 text-white rounded-xl py-4 pl-10 pr-4 text-3xl focus:border-orange-500 transition-all"
                                    required>
                            </div>
                        </div>

                        <div class="hidden space-y-2 transform transition-all duration-300 origin-top"
                            id="description-container">
                            <label for="description"
                                class="flex items-center gap-2 text-xs font-bold text-amber-500 uppercase tracking-widest">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                                Motivo del Desfase <span class="text-sm text-gray-500">Diferencia encontrada: <span
                                        id="expected-amount"></span></span>
                            </label>
                            <textarea id="description" placeholder="Describa la razón de la diferencia detectada..."
                                class="w-full bg-zinc-950 border border-zinc-800 text-zinc-200 rounded-xl p-4 text-sm h-24 resize-none focus:outline-none focus:ring-2 focus:ring-orange-500/50 focus:border-orange-500 transition-all"></textarea>
                        </div>

                    </div>
                </div>

                <div class="px-8 py-4 bg-(--bg-main) border-t border-(--border) flex justify-end gap-3">
                    <button onclick="close_modal()"
                        class="px-6 py-2.5 rounded-xl border border-red-500 text-red-500 text-xs font-bold uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all cursor-pointer">Cancelar</button>
                    <button onclick="close_cash()"
                        class="px-6 py-2.5 rounded-xl bg-(--accent) text-white text-xs font-bold uppercase tracking-widest hover:bg-(--accent-hover) transition-all cursor-pointer">Cerrar
                        Caja</button>
                </div>
            </div>
        </div>

    </div>
</main>

<script>
    function init_chart() {
        const weekly_performance = {{ company.metrics.weekly_performance | dump | safe }};

        const labels = weekly_performance.map(d => d.day);
        const sales_data = weekly_performance.map(d => d.sales);
        const expenses_data = weekly_performance.map(d => d.expenses);

        const ctx = document.getElementById('weekly_performance_chart').getContext('2d');

        Chart.defaults.color = '#8B949E';
        Chart.defaults.font.family = "'Inter', sans-serif";

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ventas',
                        data: sales_data,
                        backgroundColor: '#FD420A',
                        borderRadius: 6,
                        barThickness: 12,
                    },
                    {
                        label: 'Gastos',
                        data: expenses_data,
                        backgroundColor: '#30363D',
                        borderRadius: 6,
                        barThickness: 12,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#151B23',
                        padding: 12,
                        titleFont: { size: 12, weight: 'bold' },
                        bodyFont: { size: 12 },
                        borderColor: '#30363D',
                        borderWidth: 1,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false },
                        ticks: { callback: (v) => 'S/ ' + v }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart'
                }
            }
        });
    }

    init_chart();
</script>

<script>
    let already_check = false;
    const company_id = {{ company_information.id | dump | safe }};;

    function open_modal(type, id) {
        if (!type || !id) return;

        const modal = document.getElementById(`${id}`);

        if (modal) modal.classList.add("active")
        document.body.style.overflow = "hidden";
    }

    function close_modal() {
        const overlay = document.querySelectorAll(".modal-overlay");

        overlay.forEach((e) => {
            if (e.classList.contains("active")) e.classList.remove("active");
        })

        document.body.style.overflow = "auto";
    }

    document.addEventListener('DOMContentLoaded', () => {
        const overlays = document.querySelectorAll(".modal-overlay");

        overlays.forEach((overlay) => {

            overlay.addEventListener("click", () => {
                close_modal();
            });

            const content = overlay.querySelector(".modal-content");

            if (content) {
                content.addEventListener("click", (e) => {
                    e.stopPropagation();
                });

                content.addEventListener("keydown", async (e) => {
                    if (e.key === "Enter") {
                        await close_cash();
                    }
                });
            }
        });
    });

    function show_description(difference_amount) {
        const difference_amount_container = document.querySelector("#expected-amount");
        const description_container = document.querySelector("#description-container");

        if (description_container.classList.contains("hidden")) description_container.classList.remove("hidden");
        difference_amount_container.textContent = `S/${difference_amount}`;
    }

    async function close_cash() {
        const amount = document.querySelector("#amount");
        const description = document.querySelector("#description");

        let amount_v = 0;
        let description_v = "No description";

        if (amount.value) amount_v = amount.value;
        if (description.value) description_v = description.value;

        const data = {
            amount: amount_v,
            description: description_v
        };

        const response = await fetch(`/companies/${company_id}/api/cash/close`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.error) {
            notify("Algo sucedio...", "error");
            return;
        }

        if (result.invalid_description) {
            show_description(result.difference);
            notify("Se encontro una diferencia con el dinero esperado, por favor sustente el motivo de la diferencia", "info");

            return;
        } else {
            notify("Caja cerrada correctamente!", "success");

            setTimeout(() => {
                return location.reload();
            }, 1500);
        }
    }

</script>

{% include "components/dashboard-footer.njk" %}

{% endblock %}