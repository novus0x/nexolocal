{% extends "layouts/dashboard.njk" %}

{% block title %}Platform Dashboard{% endblock %}

{% block content %}
{% include "components/text-editor.njk" %}
{% include "components/dashboard-sidebar.njk" %}
{% include "components/dashboard-header.njk" %}

<main class="flex-1 overflow-y-auto p-6 lg:p-10">
    <div class="w-full space-y-8">
        
        <div class="mb-8">
            <nav class="flex mb-3 text-xs font-bold tracking-widest text-gray-500 flex-col md:flex-row gap-5"
                aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3 uppercase">
                    <li class="inline-flex items-center">
                        <a href="/platform" class="hover:text-white transition-colors">Dashboard</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <a href="/platform/support" id="breadcrumb-workspace"
                                class="hover:text-white ml-1 md:ml-2 transition-colors">Soporte</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <a href="#" id="breadcrumb-workspace"
                                class="hover:text-white ml-1 md:ml-2 transition-colors">Tickets</a>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <i class="fa-solid fa-chevron-right text-gray-600"></i>
                            <span class="ml-1 md:ml-2 text-orange-500">{{ ticket.code }}</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-8">
                <div class="relative activity-line space-y-10 pl-4">

                    {% for item in ticket.items %}
                    <div class="relative flex gap-6">
                        <div
                            class="w-14 h-14 rounded-xl flex items-center justify-center shrink-0 z-10 overflow-hidden">
                            {% if item.user.staff %}
                            <img src="/public/img/logo.svg" alt="Avatar">
                            {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ item.user.fullname }}&amp;background=FD420A&amp;color=fff"
                                alt="Avatar">
                            {% endif %}
                        </div>
                        <div class="glass-card rounded-2xl p-6 flex-1 shadow-sm">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-white/5">
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-bold text-white uppercase tracking-wider">{{
                                        item.user.fullname }}</span>
                                    {% if item.user.staff %}
                                    <span
                                        class="text-[9px] px-2 py-0.5 rounded bg-(--accent)/10 text-(--accent) font-bold border border-(--accent)/20 uppercase">Staff</span>
                                    {% endif %}
                                    {% if not item.is_public %}
                                    <span
                                        class="text-[9px] px-2 py-0.5 rounded bg-green-500/10 text-green-400 font-bold border border-green-500/20 uppercase">Mensaje Interno</span>
                                    {% endif %}
                                </div>
                                <span class="text-[10px] font-mono text-zinc-500">{{ item.date }}</span>
                            </div>

                            <div class="editor-wrapper view">
                                <div class="ql-snow">
                                    <div class="ql-editor">
                                        {{ item.content | safe }}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    {% endfor %}

                </div>

                <div class="glass-card rounded-2xl overflow-hidden">

                    <div class="px-6 py-3 border-b border-white/5 flex justify-between items-center">
                        <span class="text-[11px] font-semibold text-zinc-400 uppercase tracking-widest">
                            Respuesta del Soporte
                        </span>
                    </div>

                    <div class="editor-wrapper edit">
                        <div id="editor"></div>
                    </div>

                    <div class="px-5 py-4 flex flex-row items-center justify-between gap-5">
                        <div>
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" id="internal" class="custom-checkbox">
                                <span class="text-xs text-(--accent) group-hover:text-(--accent-hover) transition-colors">Marcar como mensaje interno</span>
                            </label>
                        </div>
                        <button onclick="new_response()"
                            class="bg-(--accent) hover:bg-(--accent-hover) text-white px-6 py-3 rounded-2xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-xl shadow-orange-900/20 active:scale-95 cursor-pointer">
                            Enviar
                        </button>
                    </div>

                </div>

            </div>

            <div class="lg:col-span-4 space-y-6">

                <div class="glass-card rounded-2xl p-6 shadow-2xl space-y-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-[10px] font-black text-white uppercase tracking-[0.2em]">Configuración del
                            Ticket</h3>
                        <svg class="w-4 h-4 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                                stroke-width="2"></path>
                        </svg>
                    </div>

                    <div>
                        <label
                            class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest block mb-2 px-1">Categoría
                            Técnica</label>
                        <select
                            class="custom-select w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs font-bold text-zinc-300 focus:outline-none focus:ring-1 focus:ring-orange-500/50">
                            <option class="bg-zinc-900">Soporte Software</option>
                            <option class="bg-zinc-900" selected>Infraestructura & Servidores</option>
                            <option class="bg-zinc-900">Pasarela de Pagos</option>
                            <option class="bg-zinc-900">Hardware / POS</option>
                            <option class="bg-zinc-900">Consultas de Usuario</option>
                        </select>
                    </div>

                    <div>
                        <label
                            class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest block mb-2 px-1">Estado
                            del Flujo</label>
                        <select
                            class="custom-select w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs font-bold text-blue-400 focus:outline-none">
                            <option class="bg-zinc-900">Abierto / Nuevo</option>
                            <option class="bg-zinc-900 text-blue-400" selected>En Análisis (Nivel 2)</option>
                            <option class="bg-zinc-900">Pendiente de Terceros</option>
                            <option class="bg-zinc-900">Bloqueado / Escalado</option>
                        </select>
                    </div>

                    <div>
                        <label
                            class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest block mb-2 px-1">Prioridad
                            / Urgencia</label>
                        <select
                            class="custom-select w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs font-bold text-red-500 focus:outline-none">
                            <option class="bg-zinc-900 text-red-500 font-bold" selected>Urgencia Crítica (P1)</option>
                            <option class="bg-zinc-900 text-orange-400">Prioridad Alta (P2)</option>
                            <option class="bg-zinc-900 text-yellow-500">Normal (P3)</option>
                            <option class="bg-zinc-900 text-zinc-500">Baja / Informativa</option>
                        </select>
                    </div>

                    <div class="pt-4 border-t border-white/5">
                        <button
                            class="w-full py-3.5 bg-zinc-100 text-black text-[10px] font-black rounded-xl uppercase tracking-[0.2em] shadow-lg hover:bg-white transition-all active:scale-95">
                            Actualizar Propiedades
                        </button>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-[10px] font-black text-white uppercase tracking-[0.2em] mb-4">Resolución</h3>
                    <p class="text-[11px] text-zinc-500 mb-5 leading-relaxed">Solo proceda al cierre si la incidencia ha
                        sido validada por el cliente y el equipo técnico.</p>

                    <div class="space-y-3">
                        <button
                            class="w-full py-3 bg-green-600/10 border border-green-600/30 text-green-500 text-[9px] font-black rounded-xl uppercase tracking-widest hover:bg-green-600 hover:text-white transition-all">
                            Cerrar Ticket como Resuelto
                        </button>
                        <button
                            class="w-full py-3 bg-zinc-800 border border-white/5 text-zinc-400 text-[9px] font-black rounded-xl uppercase tracking-widest hover:bg-red-900/30 hover:text-red-400 hover:border-red-900/50 transition-all">
                            Cancelar Ticket (Anular)
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card rounded-2xl p-4 text-center">
                        <p class="text-[8px] text-zinc-500 uppercase font-bold mb-1 tracking-tighter">Tiempo Total</p>
                        <p class="text-sm font-mono text-zinc-300 font-bold">1h 45m</p>
                    </div>
                    <div class="glass-card rounded-2xl p-4 text-center">
                        <p class="text-[8px] text-zinc-500 uppercase font-bold mb-1 tracking-tighter">Interacciones</p>
                        <p class="text-sm font-mono text-zinc-300 font-bold">14</p>
                    </div>
                </div>

            </div>

        </div>

    </div>
</main>

<script>
    let valid = true;
    const ticket_id = {{ ticket.id | dump | safe }};

    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Escribe aquí la respuesta para el cliente…',
        modules: {
            toolbar: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link'],
                ['clean']
            ]
        }
    })

    async function new_response() {
        if (!valid) return;

        const internal = document.getElementById("internal");

        const description = quill.root.innerHTML;

        if (!description || description === '<p><br></p>') {
            notify("La descripción no puede estar vacía", "error");
            return;
        }

        const payload = {
            ticket_id, description,
            internal: internal.checked
        }

        const response = await fetch('/platform/api/support/tickets/response/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
            valid = false;

            notify("Respuesta enviada", "success");
            setTimeout(() => {
                window.location.reload();
            }, 1500)
        } else {
            result.errors.forEach(e => {
                notify(`${e}`, "error");
            });
        }
    }

</script>

{% include "components/dashboard-footer.njk" %}

{% endblock %}